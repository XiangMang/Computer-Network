1. 网络核心: 因特网端系统的分组交换机和链路构成的网状结构.
2. 通过网络链路和交换机移动数据有两种基本方法: **电路交换(circuit switching)** 和 **分组交换(packet switching)**.

### 1.3.1 分组交换
1. 在某种网络应用中, 端系统彼此交换 **报文(message)**. 报文能够包含该应用的设计者需要的任何东西. 报文可以执行一种控制功能, 也可以包含数据.
2. 为了从源端系统向目的端系统发送一个报文, 源将长报文划分为较小的数据块, 称为 **[[1.1 什么是Internet#^packet|分组(packet)]]** .
3. 在源和目的地之间, 每个分组都通过通信链路和 **分组交换机(packet switch)** 传送, 交换机主要有 **路由器(router)** 和 **链路层交换机(link-layer switch)** 两类. 分组以等于该链路*最大*传输速率的速度通过通信链路. 因此, 如果某源端系统或分组交换机经过一条链路发送一个 $L$ bit的分组, 链路的传输速率为 $R$ bps, 则传输给分组的时间为 $L/R$ s.

#### 1. 存储转发输送
多数分组交换机在链路的输入端使用 **存储转发传输(store-and-forward transmission)** 机制. 其是指在交换机开始向传输链路传输该分组的第一个比特之前, 必须接收到整个分组.

>以两个端系统经一台路由器连接构成的简单网路为例(忽略传播时延)
![[网络核心配图_1.png]]

在某个特定的时刻, 源已经传输了分组1的一部分. 因为该路由器应用了存储转发机制, 所以此时必须先缓存(即"存储")该分组的比特.仅当路由器已经接收完该组分组的*所有*比特后, 他才能开始向出链路传输(即"转发")该分组.

1. 源在时刻 $0$ 开始传输, 在时刻 $L/R$, 源传输了整个分组, 并且整个分组已被接收, 存储在路由器中.
2. 在时刻 $L/R$, 路由器刚好接收到整个分组, 并朝着目的地向出链路传输分组.
3. 在时刻 $2L/R$, 路由器传输完了整个分组, 且整个分组以被目的地接收.
   - 总延时为 $2L/R$. (而如果不使用存储转发输送机制, 其总延时为 $L/R$.)

以此类推, 在时刻 $4L/R$, 目的地已经收到所有三个分组!
由此, 我们可以得出一条一般性的规律: 通过 $N$ 条速率均为 $R$ 的链路组成的路径(所以, 在源和目的地之间有 $N-1$ 台路由器), 从源目的地发送*一个分组*, 其端到端的时延为:
$$
d_{end-end}=N \frac{L}{R}
$$
在上述条件下, 如果有 $P$ 个分组进行传输, 其端到端的时延为:
$$
d_{end-end}=(N+P-1) \frac{L}{R}
$$
公式可以看成 $N \frac{L}{R}$ (第一个分组传输所需要的时间)加上 $(P-1)\frac{L}{R}$ 剩下的分组需要的时间.
#### 2. 排队时延和分组丢失
1. 每台分组交换机有多条链路与之连接. 对于每条相连的链路, 该分组交换机具有一个 **输出缓存[output buffer, 也称为输出队列(output queue)]**, 它用于存储路由器准备发往那条链路的分组. 该输出缓存在分组交换中起着重要的作用, 该到达分组必须在输出缓存中等待. 
2. 除了存储转发时延以外, 分组还要承受输出缓存的 **排队时延(queuing-delay)**. 这些时延是变化的, 变化的程度取决于网络的拥塞等级. 因为缓存空间的大小是有限的, 一个到达的分组可能发现该缓存已被其他等待传输的分组完全充满了. 在此情况下, 将出现 **分组对视(丢包)(packet loss)**, 到达的分组或已经排队的分组之一将被丢弃.

![[排队延迟和丢失配图.png]]
#### 3. 转发表和路由器选择协议
1. 在因特网中, 每个端系统具有一个称为IP地址的地址. 当源主机要向目的端系统发送一个分组时, 源在该分组的首部字节中包含了目的地的IP地址. 如同邮政地址那样, 该地址具有一种等级结构. 当一个分组到达网络中的路由器时, 路由器检查该分组的目的地址的一部分, 并向一台相邻的路由器转发该分组.
2. 更特别的是, 每台路由器具有一个 **转发表(forwarding table)**, 用于将目的地址(或目的地址的一部分)映射为输出链路. 当某分组到达了一台路由器时, 路由器检查该地址, 并用这个目的地址搜索其转发表, 以发现适当的出链路. 路由器再将分组导向该出链路.该过程可以用快递的运输来进行类比.
3. 因特网具有一些特殊的 **路由选择协议(routing protocol)**, 用于自动地设置这些转发表.

### 1.3.2 电路交换
1. 在电路交换网络中, 在端系统间通信会话期间, *预留*了端系统间路径通信所需要的资源(缓存, 链路传输速率). 在分组交换网络中, 这些资源则是*不预留*的. 会话的报文按需使用这些资源, 其后果可能是不得不等待(即排队)接入通信线路. 可以类比为一个需要顾客预定的餐馆(电路交换), 一个不需要预定的餐馆(网路交换).
2. 以传统的电话网络为例. 在发送方能够发送信息之前, 该网络必须在发送方和接收方之间建立一条连接. 这是一个*名副其实*的连接, 以为此时发送方和接收方之间路径上的交换机都将为该连接维护连接状态
3. 当网络创建这种电路时, 它也在连接期间在该网络链路上预留了恒定的传输速率(表示为每条链路传输容量的一部分). 既然已经为该发送方-接收方连接预留了宽带, 则发送方能够以*确保*的恒定速率向接收方传输数据.
>以四台交换机和四条链路组成的一个简单的电路交换网络为例
>![[电路交换配图.png]]

4. 由图可知, 每条链路能够支持四条并行的连接. 每台主机都与一台交换机直接相连. 当两台主机要通信时, 该网络在两台主机主机之间创建了一条专用的 **端到端连接(end-to-end connection)**. 因为每条链路具有四条电路, 对于端到端连接所使用的每条链路而言, 该连接在连接期间获得链路总传输容量的 $1/4$.
#### 1. 电路交换网络中的复用
1. 链路中的电路是通过 **频分复用(Frequency-Division Multiplexing, FDM)** 或 **时分复用(Time-Division Multiplexing, TDM)** 来实现的. 
2. 对于FDM, 链路的频谱由跨越链路创建的所有连接共享. 在连接期间链路为每条连接专设一个频段, 该频段的宽度称为 **带宽(band-width)**.
3. 对于一条TDM链路, 时间被划分为固定时段的帧, 并且每个帧又被划分为固定数量的时隙. 当网络跨越一条链路创建一条连接时, 网络在每个帧为该连接指定一个时隙. 这些时隙专门由该链接单独使用, 一个时隙(在每个帧内)可用于传输该连接的数据.

>以一个支持四条电路的链路的FDM和TDM为例
>![[FDM与TDM配图.png]]
>对于FDM, 其频率域被分割为四个频段; 对于TDM, 其时域被分割为帧, 在每个帧中具有四个时隙, 在循环的TDM帧中每条电路被分配相同的专用时隙.

对于TDM, 一条电路的传输速率等于帧速率乘以一个时隙中比特的数量. 如果链路每秒传输8000个帧 ,每个时隙由8个比特著称, 则每条电路的传输速率是 $64kbps$. 
例题可见[[FDM与TDM计算举例.png|这里]]. 其传输时间与链路数量无关, 端到端电路不管是通过1条链路还是通过100条链路, 传输时间都将是10s.

#### 2. 分组交换与电路交换的对比
1. 考虑一台主机经过分组交换网络向另一台主机发送分组的情况. 与使用电路交换相同, 该分组经过一系列通信链路传输. 但与电路交换不同的是, 该分组被发送进网络, 而不预留任何链路资源之类的东西. 如果因为此时其他分组也需要经该链路进行传输而使链路之一出现拥塞, 则该分组将不得不在传输链路发送测的缓存中等待而产生时延. 因特网进最大努力以即使方式交付分组, 但它不做任何保证.
2. 电路交换不够经济, 因为在 **静默期(silent period)** 专用电路是空闲的. 并且创建端到端电路和预留端到端带宽是复杂的, 需要复杂的信令软件以协调沿端到端路径的交换机的操作.
3. 分组交换更加有效. 同样的网络资源, 分组交换允许更多用户使用网络.

假设多个用户共享一条 $1Mbps$ 的链路, 再假定每个用户的活跃周期是变化的. 在活跃期间, 用户以 $100kbps$ 的恒定速率产生数据, 在静止期间, 用户不产生数据. 进一步假定该用户仅有 $10\%$ 的时间活跃. 对于电路交换, 在所有的时间内必须为*每个用户预留* $100kbps$.

因此, 该电路交换链路仅能支持10个并发用户. 对于分组交换, 一个特定用户活跃的概率为 $10\%$. 如果有35个用户, 有11或更多个并发活跃用户的概率大约是 $0.04\%$. 当有10个或更少并发用户时, 到达的聚合数据速率小于或等于该链路的输出速率 $1Mbps$. 因此, 当有10个或更少的活跃用户时, 通过该链路的分组流基本上没有时延, 这与电路交换的情况一样. 当活跃用户超过10个小时, 分组的聚合到达速率超过该链路的输出容量, 则输出队列将变长. 因为在本例中同时活跃用户超过10个的概率极小, 分组交换差不多总是提供了与电路交换相同的性能, 并且在用户数量是其三倍时, 情况也是如此.

其计算公式如下:
$$
1-\sum_{n=0}^9 \binom{35}{n}p^n(1-p)^{35-n}
$$

现在考虑第二个例子. 假定有10个用户, 某个用户突然会产生1000个有 $1000bit$ 的分组, 而其他用户则保持沉默, 不产生分组. 在每帧具有10个时隙并且每个时隙包含 $1000bit$ 的TDM电路交换情况下,活跃用户仅能使用每帧中的一个时隙来传输数据, 而每个帧中剩余的9个时隙保持空闲. 该活跃用户传输完所有 $10^6bit$ 数据需要 $10s$ 的时间. 在分组交换情况下, 活跃用户能够连续地以 $1Mbps$ 的全部链路速率发送其分组. 因为没有其他用户产生分组与该活跃用户的分组进行复用. 在此情况下, 该活跃用户的所有数据将在 $1s$ 内发送完毕.

综上, 在多个数据流之间共享链路传输速率的两种形式之间存在关键差异. 电路交换不考虑需求, 而预先分配了传输链路, 这使得已分配而并不需要的链路时间未被利用. 另一方面, 分组交换按需分配链路, 链路传输能力将在所有需要在链路上传输分组的用户之间逐分组地被共享.

### 1.3.3 网络的网络

在前面看到, 端系统经过一个接入ISP与因特网相连. 但通过接入ISP为端用户和内容提供商提供连接仅解决了连接难题中的很小一部分. 因为因特网是由数以亿计的用户组成的. 要解决这一问题, 接入ISP必须互联. 通过创建*网络的网络*可以解决这一问题. 这是理解因特网的关键.
1. 用单一的全球传输ISP互联所有接入ISP, 这样的一个网络结构我们称为*网络结构1*. 我们假象的全球传输ISP是一个由路由器和通信链路构成的网络, 该网络不仅跨越全球, 而且至少拥有一台路由器靠近数十万接入ISP中的每一个. 全球传输ISP相接入ISP收费, 其价格不一定正比于一个接入ISP经过全球ISP交换的流量大小. 接入ISP被称为 **客户(customer)**, 全球传输ISP被称为 **提供商(provider)**.
2. 如果存在一个可盈利的全球传输ISP, 则之后必然有其他的全球传输ISP被建立与其竞争,  这就是*网络结构2*. 需要注意的的是, 这些全球传输ISP之间一定是互联的, 不然的话, 连接到某个全球传输ISP的接入ISP将不能与其他连接到另一个全球传输ISP的接入ISP进行通信. 网络结构2是一种两层的等级结构. 全球传输提供商位于顶层, 接入ISP位于底层. 但是世界上没有哪个ISP是无处不在的. 相反, 在任何给定的区域, 可能有一个 **区域ISP(regional ISP)**, 区域中的接入ISP与之连接. 每个区域ISP则与 **第一层ISP(tier-1 ISP)** 连接. 
3. 现在我们可以细化一下这个网络的网络. 不仅有多个第一层ISP, 而且在一个区域可能有多个竞争的区域ISP. 在这样的等级结构中, 每个接入ISP向其连接的区域ISP支付费用, 而且每个区域ISP向它连接的第一层ISP付费. (一个接入ISP可以与第一层ISP直接相连. ) 在这个等级结构的每一层, 都存在着客户-提供商的关系. (第一层ISP不向任何人付费. ) 这个多等级的结构我们称为*网络结构3*.
4. 为了与当今的网络更加类似, 我们需要在等计划网络结构3上增加 **存在点(Point of Presence, PoP)**, 多宿, 对等和因特网交换点.
   PoP存在于等级结构的所有层次(底层ISP除外). 一个PoP只是提供商网络中的一台或多台路由器(在相同位置)群组, 其中客户ISP能够与提供商ISP连接. 对于要与提供商PoP连接的客户网络, 它能从第三方电信提供商租用高速链路并将它的路由器之一连接到位于该PoP的一台路由器. 
   任何一个ISP(除了第一层ISP)都可以选择 **多宿(multi-homr)**, 即可以与两个或更多提供商ISP连接. 当一个ISP为多宿的时候, 即使提供商之一出现故障, 其仍然能够在因特网中发送和接收分组. 
   客户ISP需要向提供商ISP付费. 为了减少这些费用, 位于相同等级结构层次的邻近的一对ISP能够 **对等(peer)**. 也就是说直接将它们的网络连接到一起, 使得它们之间的所有流量经直接连接而不是通过上游的中间ISP传输. 当两个ISP对等时, 通常不进行结算.
   同样的, 第三方公司能够创建一个 **因特网交换点(Internet Exchange Point, IXP)**. IXP是一个汇合点, 多个ISP能够在这里一起对等.
   我们称这个生态结构为*网络结构4*---由接入ISP, 区域ISP, 第一层ISP, PoP, 多宿, 对等和IXP组成.
5. 通过在网络结构4上增加 **内容提供商(content provider network)**[^1], 从而得到*网络结构5*. 谷歌数据中心通过专用的TCP/IP网络互联, 其独立于公共因特网. 谷歌专用网络仅承载出入谷歌服务器的流量.

![[互联网结构配图.png]]
综上, 现在的因特网是一个网络的网络. 由十多个第一层ISP和数十万个较低层ISP组成. 较低层的ISP与较高层的ISP相连, 较高层的ISP彼此互联. 用户和内同提供商时较低层ISP的客户, 较低层ISP是较高层ISP的客户. 近些年, 主要的内容提供商也已经创建了自己的网络, 直接在可能的地方与较低层ISP互联.

[^1]: 例如: 谷歌.